# План изменений для бесшовного воспроизведения

Этот план фиксирует шаги, необходимые для отключения автоподмены плейлиста на экране книги и сохранения непрерывного звучания между экранами.

## 1. Инициализация плеера только по действию пользователя
- Найти существующий автозапуск в экране книги (`fetchChapters`, `_autoStartPending`, `_initAudioPlayer`).
- Удалить или условно отключить вызов `setChapters`/`_initAudioPlayer` при построении экрана.
- Перенести `setChapters` + `play()` в обработчики Play/выбора главы, сохранив восстановление прогресса и стартовой позиции.

## 2. Проверка текущего плейлиста перед сменой источника
- В `AudioPlayerProvider.setChapters` или в месте вызова добавить проверку: если уже играет другой плейлист и пользователь не запрашивал смену, не заменять источник.
- Расширить существующую логику «same playlist», чтобы не перезаписывать активное воспроизведение без явного намерения.

## 3. Перенос вспомогательных инициализаций в пользовательский старт
- Убедиться, что при явном `setChapters` выполняются: загрузка метаданных для уведомлений, ограничение гостя на первую главу, обновление `userType`, перезапуск тикера бесплатных секунд и синхронизация расписания рекламы.
- Если эти операции были привязаны к автозапуску, перенести их в обработчики пользовательского старта воспроизведения.

## 4. Восстановление позиции при первом намерении воспроизведения
- При нажатии Play/выборе главы вызывать `setChapters`, чтобы подтянуть сохранённую позицию и стартовую главу из `_getProgressForBook`.
- До запуска показать пользователю актуальные данные прогресса, чтобы он знал, откуда продолжится воспроизведение.

## 5. Поведение гостя и рекламы после отказа от автозапуска
- Проверить, что для гостя плейлист урезается до первой главы до `play()` и не ломает UX.
- Рекламный режим должен активироваться только после фактического `play()` и оставаться синхронизированным с состоянием `player.playing`.

## 6. Доработки после наблюдений в бою
- Добавить идентификатор книги в проверку «same playlist» (или отдельное поле текущей книги в провайдере), чтобы нажатие Play на другой книге всегда передавало новый плейлист в `setChapters`, даже если совпадает число/состав глав из кеша.
- На экране книги при нажатии Play явно прокидывать `userInitiated: true` и не пропускать `setChapters`, если активная книга отличается от открытой, но список глав распознан как «тот же».
- Убедиться, что после явной смены книги обновляются метаданные (`title/author/cover`), прогресс и ограничения гостя до вызова `play()`, чтобы реклама/тикеры и уведомления переключались на новую книгу.
